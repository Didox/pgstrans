<div class="col-md-12">
  <div class="col-md-12">
    <h3>Detalhes da Venda</h3>
  </div>

  <!-- Page Heading/Breadcrumbs -->
  <%= render :partial => 'shared/header_backoffice' %>
  <!-- /.row -->  

  <div class="col-md-12">
    <dl class="dl-horizontal">
      <dt>ID da Venda:</dt>
      <dd><%= @venda.id %></dd>
      <dt>Produto no Pagasó:</dt>
      <dd>
        <% if @venda.product_id.present? %>
          <a href="/produtos/<%= @venda.product_id %>" target="_blank">
            <%= @venda.product_id %>
          </a>
        <% else %>
            <%= "#{@venda.lancamento.nome}" rescue "" %>
        <% end %>
      </dd>
      <dt>Produto no Parceiro:</dt>
      <dd>
        <%= @venda.produto_id_parceiro %>
      </dd>
      <dt>Nome do Produto:</dt>
      <dd>
        <%= @venda.product_nome %>
      </dd>
      <dt>Valor:</dt>
      <dd><%= number_to_currency(@venda.valor_original) %></dd>
      <dt>Lucro:</dt>
      <dd>
        <%= number_to_currency(@venda.desconto_aplicado) %><br>
        <% porcentagem = (@venda.desconto_aplicado.to_f / @venda.valor_original.to_f * 100) 
        unless porcentagem.nan? %>
          <%= number_to_currency(porcentagem, :unit => "") %>%
        <% end %>
      </dd>
      <dt>Custo:</dt>
      <dd><%= number_to_currency(@venda.value) %></dd>
      <% if @venda.customer_number.present? %>
        <dt>Número do Cliente:</dt>
        <dd><%= @venda.customer_number %></dd>
      <% end %>
      <% if @venda.smartcard.present? %>
        <dt>Smartcard:</dt>
        <dd><%= @venda.smartcard %></dd>
      <% end %>
      <dt>Situação:</dt>
      <dd><%= @venda.status_desc.error_description_pt %> - <strong><%= "#{@venda.lancamento.nome}" rescue "" %></strong></dd>
      
      <% if @venda.partner.id == Partner.ende.id %>
        <div class="container scroltable">
          <div class="container">
            <% @info = Ende.informacoes_parse(@venda.response_get, EndeUniqNumber.find(@venda.request_id)) %>
            <div class="card" style="margin-top: 5px;">
              <div class="card-header">
                <div class="col-md-12" style="margin-bottom: 20px; font-weight: bold; text-align: center">
                  <ul style="list-style-type: none;">
                    <li><h2>ENDE</h2></li>
                    <li>Recibo Duplicado</li>
                    <li>Empresa Nacional de</li>
                    <li>Distribuição de Electricidade</li>
                  </ul>
                </div>
                <div class="col-md-12" style="margin: 0px; font-weight: bold; text-align: left">
                  <ul style="list-style-type: none;">
                    <li>Rua Cónego Manual das Neves, 234</li>
                    <li>Caixa Postal: 43</li>
                    <li>NIF: 5410778170</li>
                    <li>EM CASO DE RECLAMAÇÕES:</li>
                    <li>TEL: 222 642700 - CALL CENTER</li>
                    <li>Data:</b> <%= @info["respDateTime"].strftime("%d/%m/%Y %H:%M:%S") rescue "" %></li>
                  </ul>
                </div>
                <div class="col-md-12" style="margin: 0px; text-align: left">
                  <ul style="list-style-type: none">
                    <li><b>Nro. Único Pagasó:</b> <%= @info["unique_number"] %></li>
                    <li><b>Cliente:</b> <%= @info["name"] %></li>
                    <li><b>NIF:</b> <%= @info["taxReferenceNo"] %></li>
                    <li><b>Endereço de Cliente:</b> <%= @info["address"] %></li>
                    <hr>
                    <li><b>N. de Conta:</b> <%= @info["accNo"] %></li>
                    <li><b>N. de Contador:</b> <%= @info["msno"] %></li>
                    <li><b>Tarifa:</b> <%= @info["tariff"] %></li>
                    <li><b>Endereço de Local de Consumo:</b> <%= "#{@info["address"]} #{@info["locRef"]}" %></li>
                  </ul>
                </div>
                <div class="col-md-12" style="margin: 0px; text-align: left">
                  <ul style="list-style-type: none">
                    <hr>
                    <li><h2>Inserir este código no Contador</h2></li>
                    <li style="letter-spacing: 3px"><h3><%= @info["stsCipher"] %></h3></li>
                    <hr>
                  </ul>
                </div>
                <div class="col-md-12" style="margin: 0px; text-align: left">
                  <ul style="list-style-type: none">
                    <li><b>Débitos</b></li>
                    <% if @info["DebtRecoveryTx"]["accDesc"].present? %>
                      <li><b><%= @info["DebtRecoveryTx"]["accDesc"] %></b></li>
                    <% end %>
                    <% if @info["DebtRecoveryTx"]["amt"]["value"].present? %>
                      <li><% if @info["DebtRecoveryTx"]["accNo"].present? %><b><%= @info["DebtRecoveryTx"]["accNo"] %>:</b><% end %> <%= number_to_currency(@info["DebtRecoveryTx"]["amt"]["value"], :precision => 2, :unit => akz_parse(@info["DebtRecoveryTx"]["amt"]["symbol"])) %></li>
                    <% end %>
                    <% if @info["DebtRecoveryTx"]["balance"]["value"].present? %>
                      <li><b>Balance:</b> <%= number_to_currency(@info["DebtRecoveryTx"]["balance"]["value"], :precision => 2, :unit => akz_parse(@info["DebtRecoveryTx"]["balance"]["symbol"])) %></li>
                    <% end %>
                    <hr>
                  </li>
                </div>
                <div class="col-md-12" style="margin: 0px; text-align: left"> 
                  <ul style="list-style-type: none">
                    <li>
                      <b>Energia:</b> <%= @info["creditTokenIssue"]["units"]["value"] %> <%= @info["creditTokenIssue"]["units"]["siUnit"] %>
                    </li>
                    <hr>
                  </ul>
                </div>
                <div class="col-md-12" style="margin: 0px; text-align: left"> 
                  <ul style="list-style-type: none">
                    <li><b>Preço Unitário:</b><br>
                    <% @info["tariffBreakdown"].each do |tariff_breakdown| %> 
                      <% if tariff_breakdown["value"]["siUnit"].present? %>
                        <%= tariff_breakdown["value"]["value"] %> 
                        <%= tariff_breakdown["value"]["siUnit"] %>
                      <% end %>
                      <% if tariff_breakdown["value"]["symbol"].present? %>
                        @                      
                        <%= number_to_currency(tariff_breakdown["value"]["value"], :precision => 2, :unit => akz_parse(tariff_breakdown["value"]["symbol"])) %><br>
                      <% end %>
                    <% end %>
                  </ul>
                </div>
                <div class="col-md-12" style="margin: 0px; text-align: left">
                  <ul style="list-style-type: none">
                    <li>
                      <hr>
                      <b>Custo de Energia:</b> <%= number_to_currency(@info["CreditVendTx"]["value"], :precision => 2, :unit => akz_parse(@info["CreditVendTx"]["symbol"])) %>
                      <hr>
                    </li>

                    <% @info["ServiceChrgTx"].each do |serviceChrgTx| %>
                      <% if serviceChrgTx["accDesc"].present? %>
                        <li><b><%= serviceChrgTx["accDesc"] %></b>
                      <% end %>
                      <% if serviceChrgTx["amt"]["value"].present? %>
                        <% if serviceChrgTx["accNo"].present? %><b><%= serviceChrgTx["accNo"] %>:</b><% end %> <%= number_to_currency(serviceChrgTx["amt"]["value"], :precision => 2, :unit => akz_parse(serviceChrgTx["amt"]["symbol"])) %></li>
                      <% end %>
                      <% if serviceChrgTx["balance"]["value"].present? %>
                        <li><b>Balance:</b> <%= number_to_currency(serviceChrgTx["balance"]["value"], :precision => 2, :unit => akz_parse(serviceChrgTx["balance"]["symbol"])) %></li>
                      <% end %>
                      <hr>
                    <% end %>
                    
                    <li>
                      <b>T o t a l :</b> <%= number_to_currency(@info["tenderAmt"]["value"], :precision => 2, :unit => akz_parse(@info["tenderAmt"]["symbol"])) %>
                      <hr>
                    </li> 

                    <li>
                      <b>Número de Recibo:</b> <%= @info["receiptNo"] %>
                      <hr>
                      <div><b>Operador:</b> <img style="width: 24px;" src="<%= asset_path('favicon.png') %>"> PAGASÓ</div>
                      <div><b>ID:</b> <%= @venda.usuario.login %></div>
                      <div><b>SGC/Índice de Tarifa:</b> <%= "#{@info["sgc"]}/#{@info["ti"]}" %></div>
                    </li> 
                  </ul>            
                </div>
              </div>
            </div>
          </div>
        </div>
        <br><br><br>
      <% end %>

      <% if @adm.id == Usuario::ROOT %>
        <dt>Request send:</dt>
        <dd><%= @venda.request_send %></dd>
        <dt>Response get:</dt>
        <dd><%= @venda.response_get %></dd>
      <% end %>
      
      <dt>Status do processamento na operadora:</dt>
      <dd><%= @venda.status_movicel %></dd>
      <dt>Data criação:</dt>
      <dd><%= @venda.created_at.strftime("%d/%m/%Y %H:%M:%S") %></dd>
      <dt>Data atualizaçao:</dt>
      <dd><%= @venda.updated_at.strftime("%d/%m/%Y %H:%M:%S") %></dd>
      <% if @venda.partner.slug.to_s.downcase == "unitel" %>
        <hr>
        <dt>Id transação Unitel:</dt>
        <dd><%= @venda.response_get_parse["idTransaction"] rescue "" %></dd>
      <% end %>
    </dl>

    <div class="page-header">
      <%= link_to 'javascript:history.go(-1)', class: 'btn btn-danger' do %>
        <span class="glyphicon glyphicon-list-alt"></span>
        Voltar
      <% end %>

      <% if @venda.partner.slug.downcase == "zaptv" && @venda.status != "7000" %>
        <%= link_to venda_reverter_venda_zaptv_path(@venda), class: 'btn btn-danger', "data-confirm"=>"Tem Certeza?", "data-method"=>"delete" do %>
          Reverter
        <% end %>
      <% end %>
    </div>
  </div>
</div>